<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Web Multifitur Deluxe</title>
    <style>
        /* --- CSS WhatsApp Dark Mode Deluxe (SAMA SEPERTI SEBELUMNYA) --- */
        :root {
            --primary-bg: #0b141a;    /* Background utama paling gelap */
            --secondary-bg: #121b22;   /* Background kontainer, sedikit lebih terang */
            --header-bg: #1f2c34;      /* Background header & input bar */
            --input-field-bg: #2a3942;  /* Background field input */
            --text-primary: #e0e0e0;     /* Teks utama (putih keabuan) */
            --text-secondary: #8696a0;   /* Teks sekunder (abu-abu, placeholder) */
            --accent-green: #00a884;    /* Hijau aksen utama WhatsApp */
            --accent-green-darker: #008a70;/* Hijau lebih tua untuk hover */
            --message-out-bg: #005c4b;   /* Bubble chat keluar */
            --message-in-bg: #1f2c34;    /* Bubble chat masuk (default, untuk bot) */
            /* BARU: Warna bubble chat masuk dari pengguna lain di grup */
            --message-group-in-bg: #262d31; 
            --link-color: #53bdeb;     /* Warna link */
            --border-color: #2c3943;    /* Border halus */
            --error-color: #ff5f5f;     /* Warna error */
            --card-padding: 20px;
            --border-radius-s: 5px;
            --border-radius-m: 8px;
            --border-radius-l: 22px; 
        }

        html, body { 
            height: 100%;
            margin: 0;
            padding: 0;
            box-sizing: border-box; 
        }
        *, *:before, *:after {
            box-sizing: inherit; 
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--primary-bg); 
            color: var(--text-primary);
            display: flex; 
            justify-content: center;
        }

        .app-wrapper {
            width: 100%;   
            max-width: 500px; 
            height: 100%;   
            background-color: var(--secondary-bg); 
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0,0,0,0.5); 
            border-radius: 0; 
            overflow: hidden; 
        }
        @media (min-width: 501px) {
            .app-wrapper {
                border-radius: var(--border-radius-m);
                max-height: 95vh; 
                margin-top: 2.5vh; 
            }
        }

        .chat-header {
            background-color: var(--header-bg);
            padding: 12px 18px;
            display: flex;
            align-items: center;
            gap: 15px;
            min-height: 50px; /* Disesuaikan agar konsisten dengan input bar */
            flex-shrink: 0;
            border-bottom: 1px solid var(--border-color);
        }
        .chat-header .avatar {
            width: 42px;
            height: 42px;
            background-color: var(--message-out-bg); /* Bisa diganti per section */
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: #fff;
            font-size: 1.2em;
        }
        .chat-header .chat-title-info .chat-name {
            font-weight: 500;
            font-size: 1.15em;
            color: var(--text-primary);
        }
        .chat-header .chat-title-info .chat-status {
            font-size: 0.8em;
            color: var(--text-secondary);
        }

        .main-content-area {
            flex-grow: 1;
            overflow-y: auto;
            background-color: var(--primary-bg); 
        }
        .main-content-area::-webkit-scrollbar { width: 6px; }
        .main-content-area::-webkit-scrollbar-thumb { background-color: var(--input-field-bg); border-radius: 3px; }
        .main-content-area::-webkit-scrollbar-track { background-color: var(--primary-bg); }

        /* Styling untuk Form Fake Story (SAMA SEPERTI SEBELUMNYA) */
        #fakeStorySection {
            padding: var(--card-padding);
            text-align: left;
            background-color: var(--secondary-bg); 
            height: 100%; 
            display: flex;
            flex-direction: column;
        }
        #fakeStorySection h2 { text-align: center; color: var(--accent-green); margin-top:0; margin-bottom: 25px; font-weight: 500; }
        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 0.9em; }
        #fakeStorySection input[type="text"], 
        #fakeStorySection textarea, 
        #fakeStorySection input[type="file"] {
            width: 100%; 
            padding: 12px; 
            margin-bottom: 5px; 
            border: 1px solid var(--border-color); 
            border-radius: var(--border-radius-s); 
            box-sizing: border-box;
            font-size: 1em; background-color: var(--input-field-bg); color: var(--text-primary);
        }
        #fakeStorySection textarea { min-height: 80px; resize: vertical; }
        #fakeStorySection input[type="file"] { padding: 10px 12px; cursor: pointer; }
        #fakeStorySection input[type="text"]::placeholder, #fakeStorySection textarea::placeholder { color: var(--text-secondary); opacity: 0.7; }
        #fakeStorySection input[type="text"]:focus, #fakeStorySection textarea:focus, #fakeStorySection input[type="file"]:focus {
            outline: none; border-color: var(--accent-green); background-color: var(--header-bg);
        }
        .button-group { margin-top: 20px; display: flex; gap: 10px; }
        .button-group button { flex: 1; }
        #generateStoryButton, #backToChatButton {
            background-color: var(--accent-green); color: white; padding: 12px 20px; border: none;
            border-radius: var(--border-radius-s); cursor: pointer; font-size: 1em; font-weight: 500;
            transition: background-color 0.2s ease; text-transform: uppercase; 
        }
        #generateStoryButton:hover, #backToChatButton:hover { background-color: var(--accent-green-darker); }
        #backToChatButton { background-color: var(--input-field-bg); }
        #backToChatButton:hover { background-color: var(--border-color); }

        #resultContainerStory { margin-top: 25px; padding: var(--card-padding); background-color: var(--header-bg); border: 1px solid var(--border-color); border-radius: var(--border-radius-m); text-align: center; }
        #resultContainerStory h3 { color: var(--accent-green); margin-top:0; margin-bottom: 15px; font-weight: 500; }
        #resultContainerStory img { max-width: 100%; height: auto; border-radius: var(--border-radius-s); margin-bottom: 15px; border: 2px solid var(--input-field-bg); }
        #downloadLinkStory { 
            display: inline-block; text-decoration: none; background-color: var(--accent-green); 
            color: white; padding: 10px 20px; border-radius: var(--border-radius-s); 
            font-size: 0.95em; font-weight: 500; transition: background-color 0.2s ease;
        }
        #downloadLinkStory:hover { background-color: var(--accent-green-darker); }
        
        /* Styling untuk Chat Interface (Downloader & BARU: Group Chat) */
        #downloaderSection, #groupChatSection { /* BARU: Ditambahkan #groupChatSection */
            height: 100%; display: flex; flex-direction: column; 
        }
        .messages-area { /* Digunakan oleh Downloader dan Group Chat */
            flex-grow: 1; padding: 15px; overflow-y: auto; 
        } 
        .message-bubble { 
            padding: 7px 12px; border-radius: var(--border-radius-m); margin-bottom: 10px; 
            max-width: 80%; word-wrap: break-word; line-height: 1.45; 
            font-size: 0.95em; clear: both; position: relative; 
            box-shadow: 0 1px 1px rgba(0,0,0,0.1); 
        }
        .message-bubble.user { /* Pesan keluar dari pengguna saat ini (di semua chat) */
            background-color: var(--message-out-bg); color: var(--text-primary); 
            margin-left: auto; float: right; border-top-right-radius: 0; 
        }
        .message-bubble.bot { /* Pesan dari bot di Downloader */
            background-color: var(--message-in-bg); color: var(--text-primary); 
            margin-right: auto; float: left; border-top-left-radius: 0; 
        }
        /* BARU: Styling untuk pesan masuk dari pengguna lain di Group Chat */
        .message-bubble.group-in { 
            background-color: var(--message-group-in-bg); color: var(--text-primary); 
            margin-right: auto; float: left; border-top-left-radius: 0; 
        }
        .message-bubble.group-in .sender-name { /* BARU: Nama pengirim di Group Chat */
            font-size: 0.8em;
            color: var(--accent-green); /* Bisa diubah warnanya */
            font-weight: 500;
            margin-bottom: 3px;
            display: block;
        }
        .message-bubble p { margin: 0 0 5px 0; }
        .message-bubble p:last-child { margin-bottom: 0; }
        .message-bubble img, .message-bubble video, .message-bubble audio { 
            max-width: 100%; border-radius: var(--border-radius-s); 
            margin-top: 8px; display: block; background-color: #000; 
        }
        .message-bubble .download-links { margin-top: 10px; }
        .message-bubble .download-links a { 
            display: inline-block; margin-right: 8px; margin-bottom: 5px; text-decoration: none; 
            background-color: var(--accent-green-darker); color: white; padding: 6px 12px; 
            border-radius: var(--border-radius-l); font-size: 0.85em; transition: background-color 0.2s ease; 
        }
        .message-bubble .download-links a:hover { background-color: var(--accent-green); }
        .message-bubble strong { color: var(--link-color); }
        .message-bubble code { 
            background-color: var(--input-field-bg); padding: 2px 5px; border-radius: 3px; 
            font-family: monospace; font-size: 0.9em; 
        }

        .input-bar { /* Digunakan oleh Downloader dan Group Chat */
            display: flex; align-items: center; padding: 8px 10px; 
            background-color: var(--header-bg); min-height: 50px; 
            position: relative; flex-shrink: 0; border-top: 1px solid var(--border-color);
        }
        .input-bar .text-input-wrapper { 
            flex-grow: 1; background-color: var(--input-field-bg); 
            border-radius: var(--border-radius-l); padding: 0 15px; 
            display: flex; align-items: center; 
        }
        .input-bar input[type="text"] { /* Digunakan oleh Downloader dan Group Chat */
            flex-grow: 1; padding: 11px 0; border: none; background-color: transparent; 
            color: var(--text-primary); font-size: 1em; 
        }
        .input-bar input[type="text"]::placeholder { color: var(--text-secondary); }
        .input-bar input[type="text"]:focus { outline: none; }
        
        /* Tombol menu hanya untuk input bar utama downloader */
        #mainInputBar .menu-button { 
            background: none; border: none; color: var(--text-secondary); 
            font-size: 1.6em; padding: 8px; cursor: pointer; margin-left: 8px; 
            transition: color 0.2s ease; 
        }
        #mainInputBar .menu-button:hover { color: var(--text-primary); }

        /* Tombol kirim (bisa dipakai di semua input bar) */
        .send-button { 
            background-color: var(--accent-green); color: white; border-radius: 50%; 
            width: 46px; height: 46px; display: flex; justify-content: center; 
            align-items: center; padding: 0; font-size: 1.2em; cursor: pointer;
            border: none; margin-left: 8px; transition: background-color 0.2s ease;
        }
        .send-button:hover { background-color: var(--accent-green-darker); }


        #attachment-menu { 
            position: absolute; bottom: 60px; /* Disesuaikan dari tinggi input bar */
            right: 10px; background-color: #233138; 
            border-radius: var(--border-radius-m); box-shadow: 0px -3px 10px rgba(0,0,0,0.3); 
            padding: 8px 0; z-index: 1000; display: none; min-width: 230px; 
        }
        #attachment-menu ul { list-style: none; padding: 0; margin: 0; }
        #attachment-menu ul li { 
            padding: 13px 20px; color: var(--text-primary); cursor: pointer; 
            font-size: 1em; display: flex; align-items: center;
        }
        #attachment-menu ul li:hover { background-color: var(--input-field-bg); }
        #attachment-menu ul li .menu-icon { 
            margin-right: 15px; width: 22px; text-align: center; 
            font-size: 1.2em; color: var(--text-secondary) 
        }

        #loadingMessageStory, #errorDisplayStory,
        .loading-message-chat, .error-message-chat { 
            margin: 15px 0;
            color: var(--text-secondary);
            font-style: italic;
            padding: 12px;
            border-radius: var(--border-radius-s);
            text-align: center;
        }
        #errorDisplayStory, .error-message-chat {
            color: var(--error-color);
            font-weight: 500;
            background-color: rgba(255, 95, 95, 0.08);
            border: 1px solid var(--error-color);
            font-style: normal;
        }

        /* BARU: Status koneksi untuk Group Chat */
        #groupChatConnectionStatus {
            padding: 8px 15px;
            font-size: 0.85em;
            text-align: center;
            background-color: var(--input-field-bg);
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
        }

    </style>
</head>
<body>
    <div class="app-wrapper">
        <div class="chat-header">
            <div class="avatar" id="appAvatar">üöÄ</div> 
            <div class="chat-title-info">
                <div class="chat-name" id="appName">Bot Web Multifitur</div>
                <div class="chat-status" id="appStatus">Online</div>
            </div>
        </div>

        <div class="main-content-area">
            <div id="downloaderSection" style="display: flex; flex-direction: column; height: 100%;">
                <div class="messages-area" id="messagesAreaDownloader">
                    </div>
            </div>

            <div id="fakeStorySection" style="display: none; height: 100%; overflow-y: auto;">
                <h2 style="text-align: center; color: var(--accent-green); margin-top:0; margin-bottom: 20px;">Fake Story Generator</h2>
                <div class="form-group">
                    <label for="usernameInput">Nama Pengguna:</label>
                    <input type="text" id="usernameInput" placeholder="Contoh: Bos Keren">
                </div>
                <div class="form-group">
                    <label for="captionInput">Caption Story:</label>
                    <textarea id="captionInput" placeholder="Contoh: Lagi santai nih... ‚ú®"></textarea>
                </div>
                <div class="form-group">
                    <label for="profilePicInputFS">Upload Foto Profil (Opsional):</label>
                    <input type="file" id="profilePicInputFS" accept="image/*">
                </div>
                <div class="form-group">
                    <label for="backgroundPicInputFS">Upload Background Story (Opsional, jika tidak diisi akan background default):</label>
                    <input type="file" id="backgroundPicInputFS" accept="image/*">
                </div>
                <div class="button-group">
                    <button id="backToChatButton">Kembali</button> <button id="generateStoryButton">Buat Story!</button>
                </div>
                <div id="loadingMessageStory" style="display:none;">‚è≥ Membuat story...</div>
                <div id="errorDisplayStory" class="error" style="display:none;"></div>
                <div id="resultContainerStory" style="display:none;">
                    <h3>Hasil Story:</h3>
                    <img id="storyImage" src="#" alt="Generated Story">
                    <a id="downloadLinkStory" href="#" download="fake_story.png">Unduh Story</a>
                </div>
            </div>

            <div id="groupChatSection" style="display: none; flex-direction: column; height: 100%;">
                <div id="groupChatConnectionStatus">Menghubungkan ke server chat...</div>
                <div class="messages-area" id="messagesAreaGroupChat">
                    </div>
            </div>
        </div>

        <div class="input-bar" id="mainInputBar" style="display: flex;">
            <div class="text-input-wrapper">
                <input type="text" id="commandInput" placeholder="Ketik perintah...">
            </div>
            <button class="menu-button" id="menuButton">‚ãÆ</button>
            <button class="send-button" id="sendButtonDownloader">‚û¢</button>
            
            <div id="attachment-menu">
                 <ul>
                     <li data-action="show-downloader"><span class="menu-icon">üì•</span>Mode Downloader</li>
                     <li data-action="show-fakestory"><span class="menu-icon">üñåÔ∏è</span>Buat Fake Story</li>
                     <li data-action="show-groupchat"><span class="menu-icon">üí¨</span>Grup Chat</li> <li data-action="info-tiktok"><span class="menu-icon">‚ÑπÔ∏è</span>Info Downloader</li>
                 </ul>
            </div>
        </div>

        <div class="input-bar" id="groupChatInputBar" style="display: none;">
            <div class="text-input-wrapper">
                <input type="text" id="groupChatMessageInput" placeholder="Ketik pesan...">
            </div>
            <button class="send-button" id="sendGroupChatMessageButton">‚û¢</button>
        </div>
    </div>

    <canvas id="storyCanvas" style="display: none;"></canvas>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const TIKTOK_API_KEY = "VintexMD"; 
        const DEFAULT_FAKESTORY_PP_URL = 'https://telegra.ph/file/24fa902ead26340f3df2c.png';

        // Elemen Header Utama
        const appNameTitle = document.getElementById('appName');
        const appStatus = document.getElementById('appStatus');
        const appAvatar = document.getElementById('appAvatar'); // Avatar di header

        // Elemen Downloader
        const downloaderSection = document.getElementById('downloaderSection');
        const messagesAreaDownloader = document.getElementById('messagesAreaDownloader');
        const commandInput = document.getElementById('commandInput');
        const sendButtonDownloader = document.getElementById('sendButtonDownloader'); // Diganti IDnya
        
        // Elemen Fake Story
        const fakeStorySection = document.getElementById('fakeStorySection');
        const usernameInput = document.getElementById('usernameInput');
        const captionInput = document.getElementById('captionInput');
        const profilePicInputFS = document.getElementById('profilePicInputFS');
        const backgroundPicInputFS = document.getElementById('backgroundPicInputFS');
        const generateStoryButton = document.getElementById('generateStoryButton');
        const backToChatButton = document.getElementById('backToChatButton'); // Akan kembali ke mode terakhir
        const loadingMessageStory = document.getElementById('loadingMessageStory');
        const errorDisplayStory = document.getElementById('errorDisplayStory');
        const resultContainerStory = document.getElementById('resultContainerStory');
        const storyImage = document.getElementById('storyImage');
        const downloadLinkStory = document.getElementById('downloadLinkStory');
        const storyCanvas = document.getElementById('storyCanvas');
        const ctx = storyCanvas.getContext('2d');

        // Elemen Menu
        const menuButton = document.getElementById('menuButton');
        const attachmentMenu = document.getElementById('attachment-menu');
        
        // Input Bar
        const mainInputBar = document.getElementById('mainInputBar');
        const groupChatInputBar = document.getElementById('groupChatInputBar'); // BARU

        // BARU: Elemen Group Chat
        const groupChatSection = document.getElementById('groupChatSection');
        const groupChatConnectionStatus = document.getElementById('groupChatConnectionStatus');
        const messagesAreaGroupChat = document.getElementById('messagesAreaGroupChat');
        const groupChatMessageInput = document.getElementById('groupChatMessageInput');
        const sendGroupChatMessageButton = document.getElementById('sendGroupChatMessageButton');
        
        let currentView = 'downloader'; // Untuk melacak view aktif: 'downloader', 'fakestory', 'groupchat'
        let websocket = null; // BARU: Untuk koneksi WebSocket Group Chat
        let userNickname = `User${Math.floor(Math.random() * 1000)}`; // Nickname sementara

        // --- Fungsi Navigasi Tampilan ---
        function showDownloaderView() {
            downloaderSection.style.display = 'flex'; 
            fakeStorySection.style.display = 'none';
            groupChatSection.style.display = 'none'; // BARU
            mainInputBar.style.display = 'flex'; 
            groupChatInputBar.style.display = 'none'; // BARU
            appNameTitle.textContent = "Bot Web Multifitur";
            appStatus.textContent = "Mode Downloader";
            appAvatar.textContent = "üöÄ";
            currentView = 'downloader';
            if (backToChatButton) backToChatButton.textContent = "Kembali ke Downloader";
        }

        function showFakeStoryView() {
            downloaderSection.style.display = 'none';
            fakeStorySection.style.display = 'block';
            groupChatSection.style.display = 'none'; // BARU
            mainInputBar.style.display = 'none'; 
            groupChatInputBar.style.display = 'none'; // BARU
            appNameTitle.textContent = "Fake Story Generator";
            appStatus.textContent = "Mode Buat Story";
            appAvatar.textContent = "üñåÔ∏è";
            currentView = 'fakestory';
            if (backToChatButton) backToChatButton.textContent = "Kembali"; // Teks umum

            // Reset form fake story
            if(resultContainerStory) resultContainerStory.style.display = 'none'; 
            if(errorDisplayStory) errorDisplayStory.style.display = 'none';
            usernameInput.value = '';
            captionInput.value = '';
            profilePicInputFS.value = null; 
            backgroundPicInputFS.value = null;
        }

        // BARU: Fungsi untuk menampilkan Group Chat View
        function showGroupChatView() {
            downloaderSection.style.display = 'none';
            fakeStorySection.style.display = 'none';
            groupChatSection.style.display = 'flex'; // Menggunakan flex
            mainInputBar.style.display = 'none';
            groupChatInputBar.style.display = 'flex'; // Tampilkan input bar khusus group chat
            appNameTitle.textContent = "Grup Chat Umum";
            appStatus.textContent = "Terhubung"; // Akan diupdate oleh status WebSocket
            appAvatar.textContent = "üí¨";
            currentView = 'groupchat';
            if (backToChatButton) backToChatButton.textContent = "Kembali"; // Teks umum

            connectWebSocket(); // Coba hubungkan WebSocket saat masuk ke view ini
            messagesAreaGroupChat.scrollTop = messagesAreaGroupChat.scrollHeight;
        }
        
        if(backToChatButton) {
            // Tombol "Kembali" di Fake Story sekarang lebih dinamis
            backToChatButton.addEventListener('click', () => {
                // Untuk sementara, selalu kembali ke downloader atau mode default
                // Nanti bisa dibuat lebih pintar untuk kembali ke view sebelumnya
                showDownloaderView(); 
            });
        }

        // --- Fungsi Utilitas Chat UI (dipakai Downloader & Group Chat) ---
        function addMessageToChatUI(content, senderType, isHtml = false, targetArea = messagesAreaDownloader, senderName = null) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message-bubble', senderType); // senderType: 'user', 'bot', 'group-in'
            
            if (senderType === 'group-in' && senderName) {
                const nameSpan = document.createElement('span');
                nameSpan.classList.add('sender-name');
                nameSpan.textContent = senderName;
                messageDiv.appendChild(nameSpan);
            }

            if (isHtml) {
                const contentDiv = document.createElement('div'); // Kontainer untuk HTML agar nama pengirim tetap di atas
                contentDiv.innerHTML = content;
                messageDiv.appendChild(contentDiv);
            } else {
                const p = document.createElement('p');
                p.textContent = content;
                messageDiv.appendChild(p);
            }
            targetArea.appendChild(messageDiv);
            setTimeout(() => { targetArea.scrollTop = targetArea.scrollHeight; }, 50);
        }
        
        // --- Logika Fake Story Generator (SAMA SEPERTI SEBELUMNYA, tidak saya ulangi di sini untuk keringkasan) ---
        // ... (Salin semua fungsi loadImageBrowser, wrapTextCenterCanvas, dan event listener generateStoryButton dari kode Anda sebelumnya) ...
        // Pastikan fungsi loadImageBrowser ada:
        function loadImageBrowser(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = "Anonymous"; 
                img.onload = () => resolve(img);
                img.onerror = (err) => {
                    console.error(`Gagal memuat gambar dari: ${url}`, err);
                    reject(new Error(`Gagal memuat gambar dari URL: ${url.substring(0,50)}...`));
                };
                img.src = url;
            });
        }

        // Pastikan fungsi wrapTextCenterCanvas ada:
        function wrapTextCenterCanvas(context, textToWrap, x, yBase, maximumWidth, linesHeight, maxLines = 7) {
            const words = textToWrap.split(' ');
            let line = '';
            let lines = [];
            context.textAlign = 'center'; 
            context.textBaseline = 'middle';
            for (let n = 0; n < words.length; n++) {
                let testLine = line + words[n] + ' ';
                let metrics = context.measureText(testLine);
                let testWidth = metrics.width;
                if (testWidth > maximumWidth && n > 0) {
                    lines.push(line.trim());
                    line = words[n] + ' ';
                } else {
                    line = testLine;
                }
            }
            lines.push(line.trim());
            if (lines.length > maxLines) {
                const slicedLines = lines.slice(0, maxLines - 1);
                let lastLine = lines[maxLines - 1];
                if (lastLine) { 
                    const estimatedDotsWidth = context.measureText("...").width;
                    while(lastLine.length > 0 && context.measureText(lastLine + "...").width > maximumWidth) {
                        lastLine = lastLine.slice(0, -1);
                    }
                    slicedLines.push(lastLine + "...");
                } else if (slicedLines.length > 0) { 
                    slicedLines[slicedLines.length-1] += "...";
                }
                lines = slicedLines;
            }
            const totalTextHeight = lines.length * linesHeight;
            let currentY = yBase - (totalTextHeight / 2) + (linesHeight / 2); 
            lines.forEach(singleLine => {
                context.fillText(singleLine, x, currentY);
                currentY += linesHeight;
            });
        }
        
        if (generateStoryButton) { // Pastikan tombol ada sebelum menambahkan event listener
             generateStoryButton.addEventListener('click', async () => {
                let username = usernameInput.value.trim() || "Pengguna Keren";
                let caption = captionInput.value.trim();
                loadingMessageStory.style.display = 'block';
                errorDisplayStory.style.display = 'none';
                resultContainerStory.style.display = 'none';
                if (username.length > 20) username = username.substring(0, 18) + "...";
                try {
                    let bgImageToDraw;
                    if (backgroundPicInputFS.files && backgroundPicInputFS.files[0]) {
                        const readerBg = new FileReader();
                        bgImageToDraw = await new Promise((resolve, reject) => {
                            readerBg.onload = (e) => loadImageBrowser(e.target.result).then(resolve).catch(reject);
                            readerBg.onerror = () => reject(new Error("Gagal membaca file background."));
                            readerBg.readAsDataURL(backgroundPicInputFS.files[0]);
                        });
                    }
                    let ppImageToDraw;
                    if (profilePicInputFS.files && profilePicInputFS.files[0]) {
                        const readerPp = new FileReader();
                        ppImageToDraw = await new Promise((resolve, reject) => {
                            readerPp.onload = (e) => loadImageBrowser(e.target.result).then(resolve).catch(reject);
                            readerPp.onerror = () => reject(new Error("Gagal membaca file PP."));
                            readerPp.readAsDataURL(profilePicInputFS.files[0]);
                        });
                    } else {
                        ppImageToDraw = await loadImageBrowser(DEFAULT_FAKESTORY_PP_URL);
                    }
                    storyCanvas.width = 720; storyCanvas.height = 1280;
                    ctx.clearRect(0, 0, storyCanvas.width, storyCanvas.height);
                    if (bgImageToDraw) {
                        ctx.drawImage(bgImageToDraw, 0, 0, storyCanvas.width, storyCanvas.height);
                    } else {
                        const gradient = ctx.createLinearGradient(0, 0, 0, storyCanvas.height);
                        gradient.addColorStop(0, '#2a3942'); 
                        gradient.addColorStop(0.5, '#1f2c34'); 
                        gradient.addColorStop(1, '#121b22'); 
                        ctx.fillStyle = gradient;
                        ctx.fillRect(0, 0, storyCanvas.width, storyCanvas.height);
                    }
                    const ppSize = 100; const ppX = 60; const ppY = 70; 
                    ctx.save(); ctx.beginPath();
                    ctx.arc(ppX + ppSize / 2, ppY + ppSize / 2, ppSize / 2, 0, Math.PI * 2, true);
                    ctx.closePath(); ctx.clip();
                    ctx.drawImage(ppImageToDraw, ppX, ppY, ppSize, ppSize);
                    ctx.restore();
                    ctx.beginPath();
                    ctx.arc(ppX + ppSize / 2, ppY + ppSize / 2, ppSize / 2 + 4, 0, Math.PI * 2, true);
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.95)'; ctx.lineWidth = 6; ctx.stroke();
                    ctx.font = 'bold 30px "Segoe UI", Arial, sans-serif'; 
                    ctx.fillStyle = '#FFFFFF';
                    ctx.shadowColor = 'rgba(0,0,0,0.6)'; ctx.shadowBlur = 5;
                    ctx.shadowOffsetX = 2; ctx.shadowOffsetY = 2;
                    ctx.textAlign = 'left'; ctx.textBaseline = 'middle';
                    ctx.fillText(username, ppX + ppSize + 25, ppY + ppSize / 2); 
                    ctx.shadowColor = 'transparent';
                    ctx.font = '38px "Segoe UI", Arial, sans-serif'; 
                    ctx.fillStyle = '#FFFFFF';
                    ctx.shadowColor = 'rgba(0,0,0,0.75)'; ctx.shadowBlur = 6;
                    ctx.shadowOffsetX = 2; ctx.shadowOffsetY = 3;
                    const captionX = storyCanvas.width / 2;
                    const captionY = storyCanvas.height * 0.60; 
                    const maxWidth = storyCanvas.width - 100;
                    const lineHeight = 52; 
                    const maxLinesCaption = 6;
                    wrapTextCenterCanvas(ctx, caption || " ", captionX, captionY, maxWidth, lineHeight, maxLinesCaption);
                    ctx.shadowColor = 'transparent';
                    const imageDataUrl = storyCanvas.toDataURL('image/png');
                    storyImage.src = imageDataUrl;
                    downloadLinkStory.href = imageDataUrl;
                    downloadLinkStory.download = `fakestory_${username.replace(/\s+/g, '_')}.png`;
                    resultContainerStory.style.display = 'block';
                    errorDisplayStory.style.display = 'none';
                } catch (e) {
                    console.error("Error membuat story:", e);
                    errorDisplayStory.textContent = `‚ùå Gagal membuat Fake Story: ${e.message}`;
                    errorDisplayStory.style.display = 'block';
                    resultContainerStory.style.display = 'none';
                } finally {
                    loadingMessageStory.style.display = 'none';
                }
            });
        }


        // --- Logika TikTok/Douyin Downloader (SAMA SEPERTI SEBELUMNYA) ---
        async function handleTikTokDouyinCommand() {
            const fullInput = commandInput.value.trim();
            if (fullInput === "") return;
            addMessageToChatUI(fullInput, 'user', false, messagesAreaDownloader);
            commandInput.value = ""; 
            const parts = fullInput.split(/\s+/);
            const command = parts[0].toLowerCase();
            const queryUrl = parts.length > 1 ? parts.slice(1).join(" ") : "";
            let platformName = "";

            if ((command === ".tiktok" || command === ".tt" || command === ".tiktod") && queryUrl) {
                if (!queryUrl.includes("tiktok.com/") && !queryUrl.includes("douyin.com/")) {
                    addMessageToChatUI('URL TikTok/Douyin tidak valid!', 'bot', false, messagesAreaDownloader); return;
                }
                platformName = queryUrl.includes("tiktok.com/") ? "TikTok" : "Douyin";
            } else if (command === ".douyin" && queryUrl) {
                 if (!queryUrl.includes("douyin.com/")) {
                    addMessageToChatUI('URL Douyin tidak valid!', 'bot', false, messagesAreaDownloader); return;
                }
                platformName = "Douyin";
            } else {
                addMessageToChatUI('Perintah tidak dikenali atau format salah.<br>Contoh:<br><code>.tiktok &lt;url&gt;</code><br><code>.douyin &lt;url&gt;</code><br>Untuk fitur lain, klik ‚ãÆ', 'bot', true, messagesAreaDownloader);
                return;
            }
            
            const apiEndpoint = platformName.toLowerCase();
            const apiUrl = `https://api.betabotz.eu.org/api/download/${apiEndpoint}?url=${encodeURIComponent(queryUrl)}&apikey=${TIKTOK_API_KEY}`;
            addMessageToChatUI(`‚è≥ Sedang memproses ${platformName} dari ${queryUrl.substring(0,30)}...`, 'bot', false, messagesAreaDownloader);
            
            try {
                // const response = await fetch(apiUrl, { timeout: 120000 }); // fetch standar tidak ada opsi timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000); // Timeout 60 detik
                const response = await fetch(apiUrl, { signal: controller.signal });
                clearTimeout(timeoutId);

                const data = await response.json();
                if (!response.ok || !data || data.status !== true || !data.result) {
                    const errorMessage = data.message || `Gagal mendapatkan data dari API ${platformName}.`;
                    addMessageToChatUI(`‚ùå Error: ${errorMessage}`, 'bot', false, messagesAreaDownloader); return;
                }
                const res = data.result;
                const { video, title, title_audio, audio } = res;
                
                let resultHtml = `<p><strong>Platform:</strong> ${platformName}</p>`;
                resultHtml += `<p><strong>Judul:</strong> ${title || 'N/A'}</p>`;
                
                const videoUrl = Array.isArray(video) ? video[0] : video;
                const audioUrl = Array.isArray(audio) ? audio[0] : audio;
                let mediaFound = false;

                if (videoUrl) {
                    resultHtml += `<video controls src="${videoUrl}" style="max-width:100%; border-radius: var(--border-radius-s);"></video>`;
                    resultHtml += `<div class="download-links"><a href="${videoUrl}" target="_blank" download="${platformName.toLowerCase()}_video.mp4">Unduh Video</a></div>`;
                    mediaFound = true;
                }
                if (audioUrl && (!videoUrl || videoUrl !== audioUrl)) { // Hanya tampilkan audio jika beda dari video
                    resultHtml += `<p style="margin-top:10px;"><strong>Audio:</strong> ${title_audio || 'Audio Terpisah'}</p>`
                    resultHtml += `<audio controls src="${audioUrl}" style="width:100%;"></audio>`;
                    resultHtml += `<div class="download-links"><a href="${audioUrl}" target="_blank" download="${(title_audio || title || platformName.toLowerCase() + '_audio').replace(/[^a-z0-9_.-]/gi, '_')}.mp3">Unduh Audio</a></div>`;
                    mediaFound = true;
                }
                if (!mediaFound) resultHtml += `<p>Tidak ada media video atau audio yang bisa ditampilkan.</p>`;
                addMessageToChatUI(resultHtml, 'bot', true, messagesAreaDownloader);

            } catch (e) {
                if (e.name === 'AbortError') {
                     addMessageToChatUI(`üöß Waktu permintaan habis saat menghubungi API ${platformName}. Coba lagi nanti.`, 'bot', false, messagesAreaDownloader);
                } else {
                     addMessageToChatUI(`üöß Terjadi kesalahan teknis (Downloader): ${e.message}`, 'bot', false, messagesAreaDownloader);
                }
            }
        }

        if (sendButtonDownloader) { // Pastikan tombol ada
            sendButtonDownloader.addEventListener('click', handleTikTokDouyinCommand);
        }
        if (commandInput) { // Pastikan input ada
            commandInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    handleTikTokDouyinCommand();
                }
            });
        }
        
        // --- BARU: Logika Group Chat ---
        function connectWebSocket() {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                groupChatConnectionStatus.textContent = `Terhubung sebagai ${userNickname}`;
                groupChatConnectionStatus.style.color = "var(--accent-green)";
                return;
            }
            if (websocket && websocket.readyState === WebSocket.CONNECTING) {
                groupChatConnectionStatus.textContent = "Sedang menghubungkan...";
                groupChatConnectionStatus.style.color = "var(--text-secondary)";
                return;
            }

            // GANTI URL INI DENGAN URL SERVER WEBSOCKET ANDA YANG SEBENARNYA
            // Contoh: 'ws://localhost:8080' atau 'wss://your-domain.com/socket'
            const WEBSOCKET_URL = 'wss://mortgage-za-doubt-ordinary.trycloudflare.com';
            
            groupChatConnectionStatus.textContent = "Menghubungkan ke server chat...";
            groupChatConnectionStatus.style.color = "var(--text-secondary)";
            
            // Anda bisa meminta nama panggilan kepada pengguna di sini
            const newNick = prompt("Masukkan nama panggilan Anda untuk chat:", userNickname);
            if (newNick && newNick.trim() !== "") {
                userNickname = newNick.trim();
            }


            websocket = new WebSocket(WEBSOCKET_URL);

            websocket.onopen = (event) => {
                console.log("WebSocket Terhubung!");
                groupChatConnectionStatus.textContent = `Terhubung sebagai: ${userNickname}`;
                groupChatConnectionStatus.style.color = "var(--accent-green)";
                addMessageToChatUI(`<i>Anda telah bergabung sebagai ${userNickname}</i>`, 'system-message', true, messagesAreaGroupChat);
                // Kirim pesan join atau identitas jika server Anda memerlukannya
                // websocket.send(JSON.stringify({ type: 'join', nickname: userNickname }));
            };

            websocket.onmessage = (event) => {
                console.log("Pesan diterima:", event.data);
                try {
                    const messageData = JSON.parse(event.data);
                    
                    // Sesuaikan format pesan ini dengan apa yang dikirim oleh server Anda
                    if (messageData.type === 'message' && messageData.nickname && messageData.text) {
                        if (messageData.nickname === userNickname) { // Pesan dari diri sendiri (jika server memantulkannya)
                             // Biasanya tidak perlu ditampilkan lagi jika sudah optimistik update,
                             // tapi server demo ini memantulkan, jadi kita bisa abaikan atau tampilkan sbg 'user'
                             // addMessageToChatUI(messageData.text, 'user', false, messagesAreaGroupChat);
                        } else {
                            addMessageToChatUI(messageData.text, 'group-in', false, messagesAreaGroupChat, messageData.nickname);
                        }
                    } else if (messageData.type === 'user_join' && messageData.nickname) {
                         addMessageToChatUI(`<i>${messageData.nickname} telah bergabung.</i>`, 'system-message', true, messagesAreaGroupChat);
                    } else if (messageData.type === 'user_leave' && messageData.nickname) {
                         addMessageToChatUI(`<i>${messageData.nickname} telah keluar.</i>`, 'system-message', true, messagesAreaGroupChat);
                    } else {
                         // Jika format tidak dikenal, tampilkan sebagai teks biasa dari "Server"
                         // Ini berguna untuk debugging server demo yang mungkin mengirim format lain
                         addMessageToChatUI(event.data, 'group-in', false, messagesAreaGroupChat, "Server");
                    }

                } catch (e) {
                    // Jika data bukan JSON atau format tidak standar, tampilkan apa adanya
                    // Server demo socketsbay mengirim pesan teks biasa saat pertama join atau jika ada error parsing
                    addMessageToChatUI(event.data, 'group-in', false, messagesAreaGroupChat, "Info Server");
                }
                messagesAreaGroupChat.scrollTop = messagesAreaGroupChat.scrollHeight;
            };

            websocket.onclose = (event) => {
                console.log("WebSocket Terputus:", event);
                groupChatConnectionStatus.textContent = "Koneksi terputus. Mencoba lagi...";
                groupChatConnectionStatus.style.color = "var(--error-color)";
                addMessageToChatUI("<i>Koneksi ke server chat terputus.</i>", 'system-error', true, messagesAreaGroupChat);
                // Coba sambungkan lagi setelah beberapa detik
                setTimeout(connectWebSocket, 5000); 
            };

            websocket.onerror = (error) => {
                console.error("WebSocket Error:", error);
                groupChatConnectionStatus.textContent = "Error koneksi WebSocket.";
                groupChatConnectionStatus.style.color = "var(--error-color)";
                addMessageToChatUI("<i>Gagal terhubung ke server chat.</i>", 'system-error', true, messagesAreaGroupChat);
            };
        }

        function sendGroupMessage() {
            const messageText = groupChatMessageInput.value.trim();
            if (messageText && websocket && websocket.readyState === WebSocket.OPEN) {
                const messagePayload = {
                    type: 'message', // Sesuaikan dengan yang diharapkan server Anda
                    nickname: userNickname,
                    text: messageText
                };
                websocket.send(JSON.stringify(messagePayload));
                
                // Tampilkan pesan sendiri secara optimistik (langsung)
                addMessageToChatUI(messageText, 'user', false, messagesAreaGroupChat);
                groupChatMessageInput.value = "";
                messagesAreaGroupChat.scrollTop = messagesAreaGroupChat.scrollHeight;

            } else if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                addMessageToChatUI("Tidak terhubung ke server chat. Coba lagi nanti.", 'system-error', true, messagesAreaGroupChat);
            }
        }

        if (sendGroupChatMessageButton) { // Pastikan tombol ada
            sendGroupChatMessageButton.addEventListener('click', sendGroupMessage);
        }
        if (groupChatMessageInput) { // Pastikan input ada
            groupChatMessageInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    sendGroupMessage();
                }
            });
        }

        // --- Logika Menu Lampiran ---
        if(menuButton && attachmentMenu) {
            menuButton.addEventListener('click', (event) => {
                event.stopPropagation();
                attachmentMenu.style.display = attachmentMenu.style.display === 'block' ? 'none' : 'block';
            });
            window.addEventListener('click', () => { 
                if (attachmentMenu.style.display === 'block') {
                    attachmentMenu.style.display = 'none';
                }
            });
            attachmentMenu.querySelectorAll('li').forEach(item => {
                item.addEventListener('click', () => {
                    const action = item.getAttribute('data-action');
                    attachmentMenu.style.display = 'none'; 

                    if (action === 'show-downloader') {
                        showDownloaderView();
                    } else if (action === 'show-fakestory') {
                        showFakeStoryView();
                    } else if (action === 'show-groupchat') { // BARU
                        showGroupChatView();
                    } else if (action === 'info-tiktok') {
                        showDownloaderView(); 
                        addMessageToChatUI("Ketik:<br><code>.tiktok https://url_tiktok_anda</code><br><code>.douyin https://url_douyin_anda</code>", 'bot', true, messagesAreaDownloader);
                    } 
                });
            });
        }
        
        // Tampilan awal
        showDownloaderView(); 
        addMessageToChatUI("Mode Pengunduh Aktif. Ketik perintah atau klik '‚ãÆ' untuk opsi lain.", 'bot', true, messagesAreaDownloader);

    });
    </script>
</body>
</html>