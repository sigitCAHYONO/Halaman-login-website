<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grup Chat Deluxe</title>
    <style>
        /* --- CSS WhatsApp Dark Mode Deluxe --- */
        :root {
            --primary-bg: #0b141a;
            --secondary-bg: #121b22;
            --header-bg: #1f2c34;
            --input-field-bg: #2a3942;
            --text-primary: #e0e0e0;
            --text-secondary: #8696a0;
            --accent-green: #00a884;
            --accent-green-darker: #008a70;
            --message-out-bg: #005c4b;
            --message-in-bg: #1f2c34;
            --message-group-in-bg: #262d31;
            --link-color: #53bdeb;
            --border-color: #2c3943;
            --error-color: #ff5f5f;
            --card-padding: 20px;
            --border-radius-s: 5px;
            --border-radius-m: 8px;
            --border-radius-l: 22px;
            --menu-bg: #233138;
            --default-pp-bg: #3A4B53;
            --checkmark-color-sent: #8696a0;
            --checkmark-color-delivered: #8696a0;
            --checkmark-color-read: #53bdeb;
        }

        html, body { height: 100%; margin: 0; padding: 0; box-sizing: border-box; }
        *, *:before, *:after { box-sizing: inherit; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--primary-bg); color: var(--text-primary);
            display: flex; justify-content: center; overflow: hidden;
        }
        .app-wrapper {
            width: 100%; max-width: 500px; height: 100%; background-color: var(--secondary-bg);
            display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.5);
            border-radius: 0; overflow: hidden;
        }
        @media (min-width: 501px) {
            .app-wrapper { border-radius: var(--border-radius-m); max-height: 95vh; margin-top: 2.5vh; }
        }
        .chat-header {
            background-color: rgba(31, 44, 52, 0.75);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            padding: 12px 18px;
            display: flex;
            align-items: center;
            gap: 15px;
            min-height: 60px;
            flex-shrink: 0;
            border-bottom: 1px solid var(--border-color);
        }
        /* BARU: Tombol Kembali di Header */
        .header-button {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.8em;
            cursor: pointer;
            padding: 0 10px 0 0;
            line-height: 1;
        }
        .header-button:hover {
            color: var(--accent-green);
        }
        .chat-header .avatar {
            width: 42px; height: 42px; background-color: var(--message-out-bg);
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            font-weight: bold; color: #fff; font-size: 1.2em;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        .chat-header .chat-title-info { flex-grow: 1; } 
        .chat-header .chat-title-info .chat-name { font-weight: 500; font-size: 1.1em; color: var(--text-primary); }
        .chat-header .chat-title-info .chat-status { font-size: 0.8em; color: var(--text-secondary); }
        .online-count { 
            font-size: 0.75em;
            color: var(--accent-green);
            background-color: rgba(0, 168, 132, 0.1);
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 10px;
            font-weight: 500;
            flex-shrink: 0;
        }

        .main-content-area { flex-grow: 1; overflow-y: auto; background-color: var(--primary-bg); position:relative; }
        .main-content-area::-webkit-scrollbar { width: 6px; }
        .main-content-area::-webkit-scrollbar-thumb { background-color: var(--input-field-bg); border-radius: 3px; }
        .main-content-area::-webkit-scrollbar-track { background-color: var(--primary-bg); }

        /* BARU: Styling untuk Halaman Home */
        #homeSection {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            padding: 20px;
            text-align: center;
            background-color: var(--primary-bg);
        }
        #homeSection h1 {
            color: var(--text-primary);
            font-weight: 500;
            font-size: 2.2em;
            margin-bottom: 10px;
        }
        #homeSection p {
            color: var(--text-secondary);
            font-size: 1.1em;
            max-width: 350px;
            line-height: 1.5;
            margin-bottom: 40px;
        }
        #enterChatButton {
            background-color: var(--accent-green);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: 600;
            border-radius: var(--border-radius-l);
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        #enterChatButton:hover {
            background-color: var(--accent-green-darker);
            transform: translateY(-2px);
        }

        #profileSettingsSection { 
            padding: var(--card-padding); 
            text-align: left; 
            background-color: var(--secondary-bg); 
            height: 100%; 
            display: flex; 
            flex-direction: column; 
        }
        #profileSettingsSection h2 { 
            text-align: center; 
            color: var(--accent-green); 
            margin-top:0; margin-bottom: 25px; 
            font-weight: 500; 
        }
        .form-group { margin-bottom: 18px; } 
        .form-group label { display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 0.9em; }
        #profileSettingsSection input[type="text"], #profileSettingsSection textarea { 
            width: 100%; padding: 12px; margin-bottom: 5px; border: 1px solid var(--border-color); 
            border-radius: var(--border-radius-s); box-sizing: border-box; font-size: 1em; 
            background-color: var(--input-field-bg); color: var(--text-primary); 
        }
        #profileSettingsSection input[type="text"]::placeholder, #profileSettingsSection textarea::placeholder { 
            color: var(--text-secondary); opacity: 0.7; 
        }
        #profileSettingsSection input[type="text"]:focus, #profileSettingsSection textarea:focus { 
            outline: none; border-color: var(--accent-green); background-color: var(--header-bg); 
        }
        .button-group { margin-top: 20px; display: flex; gap: 10px; } .button-group button { flex: 1; }
        #profileSettingsSaveButton, #profileSettingsBackButton { 
            background-color: var(--accent-green); color: white; padding: 12px 20px; border: none; 
            border-radius: var(--border-radius-s); cursor: pointer; font-size: 1em; font-weight: 500; 
            transition: background-color 0.2s ease; text-transform: uppercase; 
        }
        #profileSettingsSaveButton:hover, #profileSettingsBackButton:hover { 
            background-color: var(--accent-green-darker); 
        }
        #profileSettingsBackButton { background-color: var(--input-field-bg); } 
        #profileSettingsBackButton:hover { background-color: var(--border-color); }

        #groupChatSection { height: 100%; display: flex; flex-direction: column; }
        .messages-area {
            flex-grow: 1; padding: 10px 15px; overflow-y: auto; display: flex; flex-direction: column;
            scroll-behavior: smooth; /* DIMINTA: Membuat scroll halus */
        }
        .message-bubble {
            padding: 0; border-radius: var(--border-radius-m); margin-bottom: 8px;
            max-width: 85%; word-wrap: break-word; clear: both; position: relative;
            opacity: 0; transform: translateY(10px);
            animation: slideUpFadeIn 0.4s ease-out forwards; /* DIMINTA: Animasi lebih halus */
            display: flex; align-items: flex-start;
        }
        @keyframes slideUpFadeIn { to { opacity: 1; transform: translateY(0); } }

        .message-bubble .profile-pic-bubble {
            width: 36px; height: 36px; border-radius: 50%; background-color: var(--default-pp-bg);
            margin-right: 8px; flex-shrink: 0; object-fit: cover; border: 1px solid var(--border-color);
        }
        .message-bubble.user .profile-pic-bubble { margin-right: 0; margin-left: 8px; }

        .message-inner-wrapper {
            padding: 8px 12px; border-radius: var(--border-radius-m);
            box-shadow: 0 1px 1.5px rgba(0,0,0,0.15); width: 100%;
            display: flex; 
            flex-direction: column;
            user-select: none; 
        }

        .message-bubble.user { margin-left: auto; flex-direction: row-reverse; }
        .message-bubble.user .message-inner-wrapper { background-color: var(--message-out-bg); color: var(--text-primary); border-top-right-radius: var(--border-radius-s); }
        .message-bubble.bot .message-inner-wrapper, .message-bubble.group-in .message-inner-wrapper { background-color: var(--message-group-in-bg); color: var(--text-primary); border-top-left-radius: var(--border-radius-s); }
        .message-bubble.bot .message-inner-wrapper { background-color: var(--message-in-bg); }

        .message-bubble.group-in .sender-name {
            font-size: 0.85em; color: var(--accent-green); font-weight: 600;
            margin-bottom: 4px; display: block;
        }
        .message-inner-wrapper p { margin: 0; line-height: 1.4; font-size: 0.98em;}
        .message-inner-wrapper p + p { margin-top: 5px; }

        .message-inner-wrapper .media-attachment {
            margin-top: 5px; max-width: 100%; border-radius: var(--border-radius-s); display: block;
        }
        .message-inner-wrapper .media-attachment video, .message-inner-wrapper .media-attachment audio { width: 100%; }
        .media-caption {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-top: 5px;
            padding: 0 2px; 
            white-space: pre-wrap; 
            word-wrap: break-word;
        }

        .message-status {
            font-size: 0.7em;
            color: var(--checkmark-color-sent);
            align-self: flex-end; 
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 2px;
        }
        .message-status .checkmark {
            font-size: 0.9em; 
            line-height: 1; 
        }
        .message-status.delivered .checkmark { color: var(--checkmark-color-delivered); }
        .message-status.read .checkmark { color: var(--checkmark-color-read); }

        .message-bubble.system-message, .message-bubble.system-error {
            background-color: transparent; color: var(--text-secondary); font-style: italic;
            font-size: 0.8em; text-align: center; width: auto; max-width: 90%;
            padding: 5px 10px; margin-left: auto; margin-right: auto;
            margin-top: 5px; margin-bottom: 10px; box-shadow: none;
            border-radius: var(--border-radius-l); background-color: rgba(42, 57, 66, 0.7);
            display: block;
        }
        .message-bubble.system-error { color: var(--error-color); background-color: rgba(255, 95, 95, 0.1); }
        
        .message-inner-wrapper .reply-quote {
            background-color: rgba(0,0,0,0.2);
            padding: 6px 10px;
            border-radius: var(--border-radius-s);
            margin-bottom: 6px;
            border-left: 3px solid var(--accent-green);
            font-size: 0.9em;
            opacity: 0.9;
        }
        .reply-quote .reply-quote-sender {
            font-weight: 600;
            color: var(--accent-green);
            display: block;
        }
        .reply-quote .reply-quote-text {
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
            margin-top: 2px;
        }

        .message-inner-wrapper.flipper-border-active {
            position: relative; 
            z-index: 1; 
        }
        .message-inner-wrapper.flipper-border-active::before {
            content: "";
            position: absolute;
            top: -2px; 
            left: -2px;
            right: -2px;
            bottom: -2px;
            border-radius: inherit; 
            background: conic-gradient(
                from var(--angle), 
                var(--accent-green), 
                var(--link-color), 
                #FFEB3B, 
                #00BCD4, 
                var(--accent-green-darker), 
                var(--accent-green)
            );
            z-index: -1; 
            animation: flipper-spin 4s linear infinite; 
            padding: 2px; 
            -webkit-mask: 
                linear-gradient(#fff 0 0) content-box, 
                linear-gradient(#fff 0 0);
            mask: 
                linear-gradient(#fff 0 0) content-box, 
                linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor; 
            mask-composite: exclude; 
        }
        @property --angle {
          syntax: '<angle>';
          initial-value: 0deg;
          inherits: false;
        }
        @keyframes flipper-spin {
          to {
            --angle: 360deg;
          }
        }

        .input-bar { 
            display: flex; 
            align-items: center; 
            padding: 8px 10px; 
            background-color: rgba(31, 44, 52, 0.75);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            min-height: 58px; 
            position: relative; 
            flex-shrink: 0; 
            border-top: 1px solid var(--border-color); 
        }
        .input-bar .text-input-wrapper { flex-grow: 1; background-color: var(--input-field-bg); border-radius: var(--border-radius-l); padding: 0 15px; display: flex; align-items: center; min-height: 42px; }
        .input-bar input[type="text"] { flex-grow: 1; padding: 10px 0; border: none; background-color: transparent; color: var(--text-primary); font-size: 1em; }
        .input-bar input[type="text"]::placeholder { color: var(--text-secondary); } .input-bar input[type="text"]:focus { outline: none; }
        
        .menu-button, #groupChatMenuButton { 
            background: none; 
            border: none; 
            color: var(--text-secondary); 
            font-size: 1.6em; 
            padding: 8px; 
            margin: 0 5px; 
            cursor: pointer; 
            transition: color 0.2s ease, transform 0.1s ease; 
            line-height: 1; 
        }

        .menu-button:hover, #groupChatMenuButton:hover { color: var(--text-primary); }
        .menu-button:active, #groupChatMenuButton:active {
            transform: scale(0.92);
        }

        #groupChatMenuButton { margin-left: 0; margin-right: 8px;}
        
        .send-button { 
            background-color: var(--accent-green); 
            color: white; 
            border-radius: 50%; 
            width: 44px; 
            height: 44px; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            padding: 0; 
            font-size: 1.3em; 
            cursor: pointer; 
            border: none; 
            /* DIMINTA: Posisi diubah agar lebih seimbang */
            margin: 0 5px 0 10px; 
            transition: background-color 0.2s ease, transform 0.1s ease;
            flex-shrink: 0; 
        }
        .send-button:hover { background-color: var(--accent-green-darker); }
        .send-button:active {
            transform: scale(0.92);
        }

        #group-chat-attachment-menu { position: absolute; bottom: 65px; background-color: var(--menu-bg); border-radius: var(--border-radius-m); box-shadow: 0px -4px 15px rgba(0,0,0,0.35); padding: 8px 0; z-index: 1000; display: none; min-width: 230px; animation: slideUpMenu 0.2s ease-out; }
        #group-chat-attachment-menu { left: 10px; }
        @keyframes slideUpMenu { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #group-chat-attachment-menu ul { list-style: none; padding: 0; margin: 0; }
        #group-chat-attachment-menu ul li { padding: 14px 22px; color: var(--text-primary); cursor: pointer; font-size: 1em; display: flex; align-items: center; transition: background-color 0.15s ease; }
        #group-chat-attachment-menu ul li:hover { background-color: var(--input-field-bg); }
        #group-chat-attachment-menu ul li .menu-icon { margin-right: 18px; width: 24px; text-align: center; font-size: 1.2em; color: var(--text-secondary); }
        #groupChatConnectionStatus { padding: 8px 15px; font-size: 0.85em; text-align: center; background-color: var(--input-field-bg); color: var(--text-secondary); border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
    </style>
</head>
<body>
    <div class="app-wrapper">
        <div class="chat-header" id="mainHeader" style="display: none;">
            <button id="backToHomeButton" class="header-button">&larr;</button>
            <div class="avatar" id="appAvatar">üí¨</div>
            <div class="chat-title-info">
                <div class="chat-name" id="appName">Grup Chat</div>
                <div class="chat-status" id="appStatus">Connecting...</div>
            </div>
            <span class="online-count" id="onlineUserCount">0 Online</span> 
        </div>

        <div class="main-content-area">
            
            <div id="homeSection">
                <h1>Selamat Datang</h1>
                <p>Bergabunglah dalam percakapan publik, bagikan file, dan terhubung dengan pengguna lain secara real-time.</p>
                <button id="enterChatButton">Masuk ke Grup Chat</button>
            </div>

            <div id="groupChatSection" style="display: none; height: 100%;">
                <div id="groupChatConnectionStatus">Menghubungkan ke server chat...</div>
                <div class="messages-area" id="messagesAreaGroupChat"></div>
                <div id="typingIndicator" style="font-style: italic; padding: 0 18px 8px; font-size: 0.9em; color: var(--text-secondary); height: 25px; flex-shrink: 0;"></div>
                 <button id="scrollToBottomButton" style="display: none; position: absolute; bottom: 70px; right: 15px; background-color: var(--accent-green); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.5em; cursor: pointer; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.3); align-items: center; justify-content: center;">&darr;</button>
            </div>

            <div id="profileSettingsSection" style="display: none; padding: var(--card-padding); background-color: var(--secondary-bg); height: 100%; overflow-y: auto;">
                <h2 style="text-align: center; color: var(--accent-green); margin-top:0; margin-bottom: 25px;">Profil & Pengaturan</h2>
                <div style="text-align: center; margin-bottom: 20px;">
                    <img id="profileSettingsPreviewPic" src="#" alt="Foto Profil" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid var(--accent-green); cursor: pointer; background-color: var(--default-pp-bg);">
                    <input type="file" id="profileSettingsPicInput" accept="image/*" style="display: none;">
                    <p style="font-size: 0.8em; color: var(--text-secondary); margin-top: 5px;">Klik gambar untuk ganti</p>
                </div>
                <div class="form-group">
                    <label for="profileSettingsNicknameInput">Nama Panggilan:</label>
                    <input type="text" id="profileSettingsNicknameInput" placeholder="Nama panggilan Anda">
                </div>
                <div class="form-group">
                    <label for="profileSettingsStatusInput">Status/Bio Singkat (Opsional):</label>
                    <textarea id="profileSettingsStatusInput" placeholder="Ceritakan sedikit tentang diri Anda..." style="min-height: 60px; resize: vertical; width:100%; padding: 12px; border: 1px solid var(--border-color); border-radius: var(--border-radius-s); box-sizing: border-box; font-size: 1em; background-color: var(--input-field-bg); color: var(--text-primary);"></textarea>
                </div>
                <div class="button-group" style="margin-top: 30px;">
                    <button id="profileSettingsBackButton" style="background-color: var(--input-field-bg);">Kembali ke Chat</button>
                    <button id="profileSettingsSaveButton">Simpan Profil</button>
                </div>
                <p id="profileSettingsMessage" style="text-align: center; margin-top: 15px; color: var(--accent-green); font-size: 0.9em;"></p>
            </div>
        </div>

        <div id="replyContextBar" style="background-color: var(--message-in-bg); padding: 8px 15px; border-top: 1px solid var(--border-color); flex-shrink: 0; display: none; align-items: center; justify-content: space-between;">
            <div style="border-left: 3px solid var(--accent-green); padding-left: 10px; overflow: hidden;">
                <div id="replySender" style="font-weight: bold; font-size: 0.9em; color: var(--accent-green);"></div>
                <div id="replyTextPreview" style="font-size: 0.9em; color: var(--text-secondary); white-space: nowrap; text-overflow: ellipsis; overflow: hidden;"></div>
            </div>
            <button id="cancelReplyButton" style="background: none; border: none; color: var(--text-secondary); font-size: 1.5em; cursor: pointer; padding: 0 5px;">&times;</button>
        </div>

        <div class="input-bar" id="groupChatInputBar" style="display: none;">
            <button class="menu-button" id="groupChatMenuButton">‚ãÆ</button>
            <div class="text-input-wrapper"><input type="text" id="groupChatMessageInput" placeholder="Ketik pesan..."></div>
            <button class="send-button" id="sendGroupChatMessageButton">‚û¢</button>
            <div id="group-chat-attachment-menu" style="display: none;">
                <ul>
                    <li data-gaction="send-image"><span class="menu-icon">üñºÔ∏è</span>Kirim Gambar</li>
                    <li data-gaction="send-video"><span class="menu-icon">üé¨</span>Kirim Video</li>
                    <li data-gaction="send-audio"><span class="menu-icon">üéµ</span>Kirim Audio</li>
                    <li data-gaction="change-profile-settings"><span class="menu-icon">‚öôÔ∏è</span>Profil & Pengaturan</li>
                </ul>
            </div>
        </div>
    </div>

    <div id="mediaPreviewModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 2000; justify-content: center; align-items: center; flex-direction: column; padding: 20px; box-sizing: border-box;">
        <div style="background-color: var(--secondary-bg); padding: 20px; border-radius: var(--border-radius-m); max-width: 90%; max-height: 90%; display: flex; flex-direction: column; align-items: center;">
            <img id="previewImage" src="#" alt="Pratinjau Gambar" style="max-width: 100%; max-height: 60vh; display: none; margin-bottom: 10px; border-radius: var(--border-radius-s);">
            <video id="previewVideo" controls style="max-width: 100%; max-height: 60vh; display: none; margin-bottom: 10px; border-radius: var(--border-radius-s);"></video>
            <textarea id="mediaCaptionInput" placeholder="Tambahkan caption (opsional)..." style="width: 100%; min-height: 50px; margin-bottom: 15px; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--border-radius-s); background-color: var(--input-field-bg); color: var(--text-primary); font-size: 0.9em;"></textarea>
            <div style="display: flex; gap: 10px; width: 100%;">
                <button id="cancelMediaButton" style="flex: 1; padding: 10px; background-color: var(--input-field-bg); color: var(--text-primary); border: none; border-radius: var(--border-radius-s); cursor: pointer;">Batal</button>
                <button id="sendMediaButton" style="flex: 1; padding: 10px; background-color: var(--accent-green); color: white; border: none; border-radius: var(--border-radius-s); cursor: pointer;">Kirim</button>
            </div>
        </div>
    </div>

    <input type="file" id="groupAttachmentInput" style="display: none;" />
    <input type="file" id="profilePicInput" style="display: none;" accept="image/*" />
    <audio id="chatNotificationSound" src="https://telegra.ph/file/220b5832a526a635cf653.mp3" preload="auto"></audio>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const USER_PROFILE_KEY = 'userProfileData';
        const DEFAULT_GROUP_AVATAR_URL = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%233A4B53"/><text x="50%" y="50%" dominant-baseline="central" text-anchor="middle" font-size="50" fill="white">?</text></svg>';

        // Elemen UI
        const mainHeader = document.getElementById('mainHeader');
        const appNameTitle = document.getElementById('appName');
        const appStatus = document.getElementById('appStatus');
        const appAvatar = document.getElementById('appAvatar');
        const onlineUserCount = document.getElementById('onlineUserCount'); 
        
        const homeSection = document.getElementById('homeSection');
        const enterChatButton = document.getElementById('enterChatButton');
        const backToHomeButton = document.getElementById('backToHomeButton');

        const groupChatInputBar = document.getElementById('groupChatInputBar');
        const groupChatSection = document.getElementById('groupChatSection');
        const groupChatConnectionStatus = document.getElementById('groupChatConnectionStatus');
        const messagesAreaGroupChat = document.getElementById('messagesAreaGroupChat');
        const groupChatMessageInput = document.getElementById('groupChatMessageInput');
        const sendGroupChatMessageButton = document.getElementById('sendGroupChatMessageButton');
        const groupChatMenuButton = document.getElementById('groupChatMenuButton');
        const groupChatAttachmentMenu = document.getElementById('group-chat-attachment-menu');
        const groupAttachmentInput = document.getElementById('groupAttachmentInput');
        const profilePicInput = document.getElementById('profilePicInput');
        const replyContextBar = document.getElementById('replyContextBar');
        const replySender = document.getElementById('replySender');
        const replyTextPreview = document.getElementById('replyTextPreview');
        const cancelReplyButton = document.getElementById('cancelReplyButton');
        const chatNotificationSound = document.getElementById('chatNotificationSound');
        const profileSettingsSection = document.getElementById('profileSettingsSection');
        const profileSettingsPreviewPic = document.getElementById('profileSettingsPreviewPic');
        const profileSettingsPicInput = document.getElementById('profileSettingsPicInput');
        const profileSettingsNicknameInput = document.getElementById('profileSettingsNicknameInput');
        const profileSettingsStatusInput = document.getElementById('profileSettingsStatusInput');
        const profileSettingsBackButton = document.getElementById('profileSettingsBackButton');
        const profileSettingsSaveButton = document.getElementById('profileSettingsSaveButton');
        const profileSettingsMessage = document.getElementById('profileSettingsMessage');
        const scrollToBottomButton = document.getElementById('scrollToBottomButton');
        const mediaPreviewModal = document.getElementById('mediaPreviewModal');
        const previewImage = document.getElementById('previewImage');
        const previewVideo = document.getElementById('previewVideo');
        const mediaCaptionInput = document.getElementById('mediaCaptionInput');
        const sendMediaButton = document.getElementById('sendMediaButton');
        const cancelMediaButton = document.getElementById('cancelMediaButton');

        // State Aplikasi
        let currentView = 'home';
        let websocket = null;
        let userNickname = null; 
        let userProfilePictures = {};
        let isReplying = false;
        let replyContext = null;
        let typingTimer;
        const TYPING_TIMER_LENGTH = 2500;
        const usersTyping = {};
        let newProfilePicDataUrl = null;
        let isUserScrolledUp = false;
        let pendingMediaFile = null;
        let pendingMediaDataURL = null;

        function saveUserProfile(profileData) { try { localStorage.setItem(USER_PROFILE_KEY, JSON.stringify(profileData)); console.info('Profil pengguna disimpan ke localStorage.'); return true; } catch (e) { console.error('Gagal menyimpan profil ke localStorage.', e); return false; } }
        function loadUserProfile() { try { const storedProfile = localStorage.getItem(USER_PROFILE_KEY); if (storedProfile) { const profile = JSON.parse(storedProfile); console.info('Profil pengguna dimuat dari localStorage.'); userNickname = profile.nickname || null; if (userNickname && profile.profilePicUrl) { userProfilePictures[userNickname] = profile.profilePicUrl; } return profile; } } catch (e) { console.error('Gagal memuat atau parse profil dari localStorage.', e); } return null; }
        
        loadUserProfile(); 

        function showHomeView() {
            homeSection.style.display = 'flex';
            mainHeader.style.display = 'none';
            groupChatSection.style.display = 'none'; 
            profileSettingsSection.style.display = 'none';
            groupChatInputBar.style.display = 'none'; 
            replyContextBar.style.display = 'none';
            currentView = 'home';
            // Putuskan koneksi jika kembali ke home
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.close();
            }
        }

        function showGroupChatView() {
            homeSection.style.display = 'none';
            mainHeader.style.display = 'flex';
            groupChatSection.style.display = 'flex';
            profileSettingsSection.style.display = 'none';
            groupChatInputBar.style.display = 'flex'; 
            replyContextBar.style.display = isReplying ? 'flex' : 'none'; 
            
            const myProfilePic = userProfilePictures[userNickname];
            if(appAvatar && myProfilePic && myProfilePic !== DEFAULT_GROUP_AVATAR_URL) {
                appAvatar.style.backgroundImage = `url('${myProfilePic}')`;
                appAvatar.textContent = '';
            } else if (appAvatar) {
                appAvatar.textContent = "üí¨";
                appAvatar.style.backgroundImage = '';
            }
            currentView = 'groupchat'; 
            if (groupChatAttachmentMenu.style.display === 'block') groupChatAttachmentMenu.style.display = 'none';
            connectWebSocket(); 
            if(messagesAreaGroupChat) messagesAreaGroupChat.scrollTop = messagesAreaGroupChat.scrollHeight; 
            checkScrollPosition();
        }

        function showProfileSettingsView() {
            homeSection.style.display = 'none';
            mainHeader.style.display = 'flex'; // Header tetap tampil
            groupChatSection.style.display = 'none';
            groupChatInputBar.style.display = 'none';
            replyContextBar.style.display = 'none';
            profileSettingsSection.style.display = 'block';

            appNameTitle.textContent = "Profil & Pengaturan";
            appStatus.textContent = "Kelola informasi Anda";
            const profile = loadUserProfile();
            if (profile) {
                profileSettingsNicknameInput.value = profile.nickname || '';
                profileSettingsStatusInput.value = profile.status || '';
                profileSettingsPreviewPic.src = profile.profilePicUrl || DEFAULT_GROUP_AVATAR_URL;
                if (appAvatar) {
                    if (profile.profilePicUrl && profile.profilePicUrl !== DEFAULT_GROUP_AVATAR_URL) {
                        appAvatar.style.backgroundImage = `url('${profile.profilePicUrl}')`; appAvatar.textContent = '';
                    } else {
                        appAvatar.textContent = "‚öôÔ∏è"; appAvatar.style.backgroundImage = '';
                    }
                }
            } else {
                profileSettingsNicknameInput.value = userNickname || '';
                profileSettingsStatusInput.value = '';
                profileSettingsPreviewPic.src = userProfilePictures[userNickname] || DEFAULT_GROUP_AVATAR_URL;
                if(appAvatar) appAvatar.textContent = "‚öôÔ∏è";
                if(appAvatar) appAvatar.style.backgroundImage = '';
            }
            profileSettingsMessage.textContent = '';
            newProfilePicDataUrl = null;
            currentView = 'profilesettings';
        }

        function linkify(text) { if (typeof text !== 'string') return ''; const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig; return text.replace(urlRegex, function(url) { return `<a href="${url}" target="_blank" rel="noopener noreferrer" style="color: var(--link-color); text-decoration: underline;">${url}</a>`; }); }
        function updateTypingIndicator() { const typingIndicator = document.getElementById('typingIndicator'); if (!typingIndicator) return; const currentlyTypingUsers = Object.keys(usersTyping); const count = currentlyTypingUsers.length; if (count === 0) { typingIndicator.textContent = ''; return; } if (count === 1) { typingIndicator.textContent = `${currentlyTypingUsers[0]} sedang mengetik...`; return; } if (count === 2) { typingIndicator.textContent = `${currentlyTypingUsers[0]} dan ${currentlyTypingUsers[1]} sedang mengetik...`; return; } typingIndicator.textContent = 'Beberapa orang sedang mengetik...'; }
        function initiateReply(messageId, senderName, messageText) { isReplying = true; replyContext = { messageId, senderName, messageText }; replySender.textContent = senderName; replyTextPreview.textContent = messageText; replyContextBar.style.display = 'flex'; groupChatMessageInput.focus(); }
        function cancelReply() { isReplying = false; replyContext = null; replyContextBar.style.display = 'none'; }
        function applySwipeToReplyHandler(element, messageData) { let startX = 0; let currentX = 0; let isDragging = false; const threshold = 60; function onDragStart(e) { if (e.target.tagName === 'A') return; startX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX; isDragging = true; element.style.transition = 'none'; document.body.style.cursor = 'grabbing'; } function onDragMove(e) { if (!isDragging) return; currentX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX; let deltaX = currentX - startX; if (deltaX < 0) deltaX = 0; if (deltaX > 100) deltaX = 100; element.style.transform = `translateX(${deltaX}px)`; } function onDragEnd() { if (!isDragging) return; isDragging = false; document.body.style.cursor = 'default'; element.style.transition = 'transform 0.3s ease'; const finalX = Math.abs(parseFloat(element.style.transform.replace('translateX(', '').replace('px)', '')) || 0); if (finalX > threshold) { const textForReply = messageData.text || (messageData.mediaElement ? messageData.mediaElement.tagName : 'Media'); initiateReply(messageData.id, messageData.senderName, textForReply.length > 50 ? textForReply.substring(0, 47) + '...' : textForReply); } element.style.transform = 'translateX(0px)'; } element.addEventListener('mousedown', onDragStart); element.addEventListener('touchstart', onDragStart, { passive: true }); document.addEventListener('mousemove', onDragMove); document.addEventListener('mouseup', onDragEnd); document.addEventListener('touchmove', onDragMove, { passive: true }); document.addEventListener('touchend', onDragEnd); }
        
        function checkScrollPosition() { if (!messagesAreaGroupChat || !scrollToBottomButton) return; const threshold = 100; const isScrolledToBottom = messagesAreaGroupChat.scrollHeight - messagesAreaGroupChat.scrollTop - messagesAreaGroupChat.clientHeight < threshold; isUserScrolledUp = !isScrolledToBottom; if (isUserScrolledUp && messagesAreaGroupChat.scrollHeight > messagesAreaGroupChat.clientHeight + threshold) { scrollToBottomButton.style.display = 'flex'; } else { scrollToBottomButton.style.display = 'none'; } }
        function showMediaPreview(file) { pendingMediaFile = file; const reader = new FileReader(); reader.onload = (e) => { pendingMediaDataURL = e.target.result; mediaCaptionInput.value = ''; if (file.type.startsWith('image/')) { previewImage.src = pendingMediaDataURL; previewImage.style.display = 'block'; previewVideo.style.display = 'none'; } else if (file.type.startsWith('video/')) { previewVideo.src = pendingMediaDataURL; previewVideo.style.display = 'block'; previewImage.style.display = 'none'; } mediaPreviewModal.style.display = 'flex'; }; reader.readAsDataURL(file); }
        function hideMediaPreview() { mediaPreviewModal.style.display = 'none'; previewImage.src = '#'; previewVideo.src = ''; previewImage.style.display = 'none'; previewVideo.style.display = 'none'; pendingMediaFile = null; pendingMediaDataURL = null; mediaCaptionInput.value = ''; if(groupAttachmentInput) groupAttachmentInput.value = null; }

        function addMessageToChatUI(content, senderType, isHtmlOrMedia = false, targetArea = messagesAreaGroupChat, senderName = null, mediaElement = null, messageId = null, messageData = {}) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message-bubble', senderType);
            if(messageId) messageDiv.id = messageId;
            if (senderType === 'user' || senderType === 'group-in') { const profilePicImg = document.createElement('img'); profilePicImg.classList.add('profile-pic-bubble'); let picUrl = DEFAULT_GROUP_AVATAR_URL; if (senderType === 'user' && userProfilePictures[userNickname]) { picUrl = userProfilePictures[userNickname]; } else if (senderType === 'group-in' && userProfilePictures[senderName]) { picUrl = userProfilePictures[senderName]; } profilePicImg.src = picUrl; const displayNameForAlt = senderName || userNickname; profilePicImg.alt = (displayNameForAlt || "US").substring(0, 2); messageDiv.appendChild(profilePicImg); }
            const innerWrapper = document.createElement('div');
            innerWrapper.classList.add('message-inner-wrapper');
            if (messageData.replyTo) { const quoteDiv = document.createElement('div'); quoteDiv.classList.add('reply-quote'); const quoteSender = document.createElement('span'); quoteSender.classList.add('reply-quote-sender'); quoteSender.textContent = messageData.replyTo.senderName; const quoteText = document.createElement('span'); quoteText.classList.add('reply-quote-text'); quoteText.textContent = messageData.replyTo.messageText; quoteDiv.appendChild(quoteSender); quoteDiv.appendChild(quoteText); innerWrapper.appendChild(quoteDiv); }
            if (senderType === 'group-in' && senderName) { const nameSpan = document.createElement('span'); nameSpan.classList.add('sender-name'); nameSpan.textContent = senderName; innerWrapper.appendChild(nameSpan); }
            if (mediaElement) { innerWrapper.appendChild(mediaElement); if (messageData.caption) { const captionP = document.createElement('p'); captionP.classList.add('media-caption'); captionP.textContent = messageData.caption; innerWrapper.appendChild(captionP);}}
            else if (isHtmlOrMedia) { const contentDiv = document.createElement('div'); contentDiv.innerHTML = content; innerWrapper.appendChild(contentDiv); } 
            else { const p = document.createElement('p'); p.innerHTML = linkify(content); innerWrapper.appendChild(p); }
            if (senderType === 'user') { const statusSpan = document.createElement('span'); statusSpan.classList.add('message-status'); statusSpan.innerHTML = '<span class="checkmark">‚úì</span>'; innerWrapper.appendChild(statusSpan); }
            const isTextMessage = !mediaElement && !isHtmlOrMedia && typeof content === 'string' && content.trim() !== '';
            const isAudioMessage = mediaElement && mediaElement.tagName === 'AUDIO';
            if (isTextMessage || isAudioMessage) { innerWrapper.classList.add('flipper-border-active'); }
            messageDiv.appendChild(innerWrapper);
            if (targetArea === messagesAreaGroupChat && senderType !== 'system-message' && senderType !== 'system-error') { applySwipeToReplyHandler(innerWrapper, { id: messageId, senderName: senderName, text: content, mediaElement: mediaElement }); }
            if (targetArea) { 
                const isScrolledToBottomInitially = targetArea.scrollHeight - targetArea.scrollTop - targetArea.clientHeight < 10;
                targetArea.appendChild(messageDiv); 
                if (targetArea === messagesAreaGroupChat) { if (!isUserScrolledUp || senderType === 'user' || isScrolledToBottomInitially) { targetArea.scrollTop = targetArea.scrollHeight; } checkScrollPosition(); } 
                else { targetArea.scrollTop = targetArea.scrollHeight; }
            } else { console.error("Target area for chat message is null or undefined."); }
        }

        function connectWebSocket() { if (websocket && (websocket.readyState === WebSocket.OPEN || websocket.readyState === WebSocket.CONNECTING)) { return; } const WEBSOCKET_URL = 'wss://chat.ravaelstore.my.id'; if(groupChatConnectionStatus) groupChatConnectionStatus.textContent = "Menghubungkan ke server chat..."; if(appStatus) appStatus.textContent = "Menghubungkan..."; websocket = new WebSocket(WEBSOCKET_URL); websocket.onopen = (event) => { console.info("WebSocket Terhubung!"); if (!userNickname) { let promptedNick = `User${Math.floor(Math.random() * 1000)}`; const newNick = prompt("Masukkan nama panggilan Anda untuk chat (atau atur di Profil & Pengaturan):", promptedNick); if (newNick && newNick.trim() !== "") { userNickname = newNick.trim(); } else { userNickname = promptedNick; } const initialProfile = loadUserProfile() || {}; initialProfile.nickname = userNickname; if (!initialProfile.profilePicUrl) initialProfile.profilePicUrl = DEFAULT_GROUP_AVATAR_URL; saveUserProfile(initialProfile); } if(groupChatConnectionStatus) groupChatConnectionStatus.textContent = `Terhubung sebagai: ${userNickname}`; if(appStatus) appStatus.textContent = `Terhubung sebagai: ${userNickname}`; if(groupChatConnectionStatus) groupChatConnectionStatus.style.color = "var(--accent-green)"; const myCurrentProfilePic = userProfilePictures[userNickname] || DEFAULT_GROUP_AVATAR_URL; if (myCurrentProfilePic && myCurrentProfilePic !== DEFAULT_GROUP_AVATAR_URL) { websocket.send(JSON.stringify({ type: 'profile_picture_update', nickname: userNickname, dataUrl: myCurrentProfilePic })); } if(appAvatar){ if (myCurrentProfilePic && myCurrentProfilePic !== DEFAULT_GROUP_AVATAR_URL) { appAvatar.style.backgroundImage = `url('${myCurrentProfilePic}')`; appAvatar.textContent = ''; } else { appAvatar.textContent = "üí¨"; appAvatar.style.backgroundImage = ''; } } }; websocket.onmessage = async (event) => { let messageTextContent = (event.data instanceof Blob) ? await event.data.text() : String(event.data); try { const messageData = JSON.parse(messageTextContent); if (messageData.type === 'message') { if (messageData.nickname !== userNickname) { addMessageToChatUI(messageData.text, 'group-in', false, messagesAreaGroupChat, messageData.nickname, null, messageData.id, messageData); if (chatNotificationSound && (document.hidden || currentView !== 'groupchat')) { chatNotificationSound.play().catch(error => { console.warn("Gagal memutar suara notifikasi:", error); }); } } } else if (messageData.type === 'file_message' && messageData.nickname !== userNickname) { let mediaElement; if (messageData.filetype.startsWith('image/')) { mediaElement = document.createElement('img'); mediaElement.src = messageData.filecontent; mediaElement.alt = messageData.filename; } else if (messageData.filetype.startsWith('video/')) { mediaElement = document.createElement('video'); mediaElement.src = messageData.filecontent; mediaElement.controls = true; } else if (messageData.filetype.startsWith('audio/')) { mediaElement = document.createElement('audio'); mediaElement.src = messageData.filecontent; mediaElement.controls = true; } else { mediaElement = document.createElement('a'); mediaElement.href = messageData.filecontent; mediaElement.textContent = `Unduh: ${messageData.filename}`; mediaElement.download = messageData.filename; } if(mediaElement) mediaElement.classList.add('media-attachment'); addMessageToChatUI(null, 'group-in', true, messagesAreaGroupChat, messageData.nickname, mediaElement, messageData.id, messageData); if (chatNotificationSound && (document.hidden || currentView !== 'groupchat')) { chatNotificationSound.play().catch(error => { console.warn("Gagal memutar suara notifikasi:", error); }); } } else if (messageData.type === 'profile_picture_update') { userProfilePictures[messageData.nickname] = messageData.dataUrl; if (messageData.nickname !== userNickname) { addMessageToChatUI(`<i>${messageData.nickname} memperbarui foto profil.</i>`, 'system-message', true, messagesAreaGroupChat); document.querySelectorAll('.message-bubble.group-in').forEach(bubble => { const senderNameElem = bubble.querySelector('.sender-name'); if (senderNameElem && senderNameElem.textContent === messageData.nickname) { const ppImg = bubble.querySelector('.profile-pic-bubble'); if (ppImg) ppImg.src = messageData.dataUrl; } }); } else { if(currentView === 'groupchat' && appAvatar){ appAvatar.style.backgroundImage = `url('${messageData.dataUrl}')`; appAvatar.textContent = ''; } } } else if (messageData.type === 'user_join') { addMessageToChatUI(`<i>${messageData.nickname} telah bergabung.</i>`, 'system-message', true, messagesAreaGroupChat); } else if (messageData.type === 'user_leave') { addMessageToChatUI(`<i>${messageData.nickname} telah keluar.</i>`, 'system-message', true, messagesAreaGroupChat); } else if (messageData.type === 'user_count_update') { if(onlineUserCount) onlineUserCount.textContent = `${messageData.count} Online`; } else if (messageData.type === 'typing' && messageData.nickname !== userNickname) { if (messageData.isTyping) { usersTyping[messageData.nickname] = true; } else { delete usersTyping[messageData.nickname]; } updateTypingIndicator(); } else if (messageData.type === 'system-message') { addMessageToChatUI(messageData.text, 'system-message', true, messagesAreaGroupChat, null, null, null, messageData); } } catch (e) { console.error("Error memproses pesan:", e, "Data:", messageTextContent); } if(messagesAreaGroupChat) messagesAreaGroupChat.scrollTop = messagesAreaGroupChat.scrollHeight; }; websocket.onerror = (error) => { console.error("WebSocket Error:", error); if(groupChatConnectionStatus) groupChatConnectionStatus.textContent = "Error koneksi."; }; websocket.onclose = (event) => { console.info("WebSocket Terputus:", event.code); if(groupChatConnectionStatus) groupChatConnectionStatus.textContent = "Koneksi terputus."; if(onlineUserCount) onlineUserCount.textContent = "0 Online"; websocket = null; if (currentView === 'groupchat') { setTimeout(connectWebSocket, 5000); } }; }
        function sendGroupMessage(text = null, payloadOverride = null) { const messageText = text || (groupChatMessageInput ? groupChatMessageInput.value.trim() : ""); if ((!messageText && !payloadOverride) || !websocket || websocket.readyState !== WebSocket.OPEN) return; clearTimeout(typingTimer); websocket.send(JSON.stringify({ type: 'typing', nickname: userNickname, isTyping: false })); const messageId = `msg-${Date.now()}-${Math.floor(Math.random() * 1000)}`; let finalPayload; if (payloadOverride) { finalPayload = payloadOverride; } else { finalPayload = { type: 'message', nickname: userNickname, text: messageText, id: messageId }; if (isReplying && replyContext) { finalPayload.replyTo = replyContext; } } websocket.send(JSON.stringify(finalPayload)); if (isReplying) { cancelReply(); } if (finalPayload.type === 'message') { addMessageToChatUI(finalPayload.text, 'user', false, messagesAreaGroupChat, userNickname, null, messageId, finalPayload); } else if (finalPayload.type === 'file_message') { let mediaElement; if (finalPayload.filetype.startsWith('image/')) { mediaElement = document.createElement('img'); mediaElement.src = finalPayload.filecontent; mediaElement.alt = finalPayload.filename; } else if (finalPayload.filetype.startsWith('video/')) { mediaElement = document.createElement('video'); mediaElement.src = finalPayload.filecontent; mediaElement.controls = true; } else if (finalPayload.filetype.startsWith('audio/')) { mediaElement = document.createElement('audio'); mediaElement.src = finalPayload.filecontent; mediaElement.controls = true; } else { mediaElement = document.createElement('p'); mediaElement.textContent = `Anda mengirim file: ${finalPayload.filename}`; } if(mediaElement) mediaElement.classList.add('media-attachment'); addMessageToChatUI(null, 'user', true, messagesAreaGroupChat, userNickname, mediaElement, messageId, finalPayload); } if(!text && !payloadOverride && groupChatMessageInput) groupChatMessageInput.value = ""; if(messagesAreaGroupChat) messagesAreaGroupChat.scrollTop = messagesAreaGroupChat.scrollHeight; }
        
        // Event Listeners
        if (enterChatButton) { enterChatButton.addEventListener('click', showGroupChatView); }
        if (backToHomeButton) { backToHomeButton.addEventListener('click', showHomeView); }
        if (sendGroupChatMessageButton) { sendGroupChatMessageButton.addEventListener('click', () => sendGroupMessage()); }
        if (groupChatMessageInput) { groupChatMessageInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') { event.preventDefault(); sendGroupMessage(); } }); }
        if(profileSettingsPreviewPic) { profileSettingsPreviewPic.addEventListener('click', () => { if(profileSettingsPicInput) profileSettingsPicInput.click(); }); }
        if(profileSettingsPicInput) { profileSettingsPicInput.addEventListener('change', (event) => { const file = event.target.files[0]; if (file) { if (file.size > 2 * 1024 * 1024) { alert("Ukuran foto profil terlalu besar! Maksimum 2MB."); profileSettingsPicInput.value = null; return; } const reader = new FileReader(); reader.onload = (e) => { profileSettingsPreviewPic.src = e.target.result; newProfilePicDataUrl = e.target.result; }; reader.readAsDataURL(file); } }); }
        if(profileSettingsSaveButton) { profileSettingsSaveButton.addEventListener('click', () => { const newNickname = profileSettingsNicknameInput.value.trim(); const newStatus = profileSettingsStatusInput.value.trim(); if (!newNickname) { alert("Nama panggilan tidak boleh kosong!"); return; } let oldProfile = loadUserProfile() || {}; let oldNicknameForServer = userNickname; const profileToSave = { nickname: newNickname, status: newStatus, profilePicUrl: newProfilePicDataUrl || oldProfile.profilePicUrl || userProfilePictures[oldNicknameForServer] || DEFAULT_GROUP_AVATAR_URL }; if (saveUserProfile(profileToSave)) { userNickname = newNickname; if (profileToSave.profilePicUrl) { userProfilePictures[userNickname] = profileToSave.profilePicUrl; } if (currentView === 'groupchat' && appAvatar) { if (profileToSave.profilePicUrl && profileToSave.profilePicUrl !== DEFAULT_GROUP_AVATAR_URL) { appAvatar.style.backgroundImage = `url('${profileToSave.profilePicUrl}')`; appAvatar.textContent = ''; } else { appAvatar.style.backgroundImage = ''; appAvatar.textContent = 'üí¨';} appNameTitle.textContent = "Grup Chat Umum"; appStatus.textContent = `Terhubung sebagai: ${userNickname}`; } else if (appAvatar && currentView === 'profilesettings') { if (profileToSave.profilePicUrl && profileToSave.profilePicUrl !== DEFAULT_GROUP_AVATAR_URL) { appAvatar.style.backgroundImage = `url('${profileToSave.profilePicUrl}')`; appAvatar.textContent = ''; } else { appAvatar.style.backgroundImage = ''; appAvatar.textContent = '‚öôÔ∏è';} } if (websocket && websocket.readyState === WebSocket.OPEN) { if (oldNicknameForServer !== newNickname && newNickname) { websocket.send(JSON.stringify({ type: 'nickname_update', oldNickname: oldNicknameForServer || "PenggunaLama", newNickname: newNickname })); } if (newProfilePicDataUrl) { websocket.send(JSON.stringify({ type: 'profile_picture_update', nickname: newNickname, dataUrl: newProfilePicDataUrl })); } } newProfilePicDataUrl = null; profileSettingsPicInput.value = null; profileSettingsMessage.textContent = 'Profil berhasil disimpan!'; setTimeout(() => { profileSettingsMessage.textContent = ''; }, 3000); } else { profileSettingsMessage.textContent = 'Gagal menyimpan profil.'; } }); }
        if(profileSettingsBackButton) { profileSettingsBackButton.addEventListener('click', () => { showGroupChatView(); }); }
        if(groupChatMenuButton) { groupChatMenuButton.addEventListener('click', (event) => { event.stopPropagation(); groupChatAttachmentMenu.style.display = groupChatAttachmentMenu.style.display === 'block' ? 'none' : 'block'; }); }
        if(cancelReplyButton) { cancelReplyButton.addEventListener('click', cancelReply); }
        if(groupChatAttachmentMenu) { groupChatAttachmentMenu.querySelectorAll('li').forEach(item => { item.addEventListener('click', () => { const action = item.getAttribute('data-gaction'); groupChatAttachmentMenu.style.display = 'none'; if (action === 'send-image' || action === 'send-video') { groupAttachmentInput.accept = action === 'send-image' ? "image/*" : "video/*"; groupAttachmentInput.onchange = (event) => { const file = event.target.files[0]; if (file) { let maxSizeMB = action === 'send-image' ? 5 : 10; if (file.size > maxSizeMB * 1024 * 1024) { alert(`Ukuran file terlalu besar! Maksimum ${maxSizeMB}MB.`); groupAttachmentInput.value = null; return; } showMediaPreview(file); } }; groupAttachmentInput.click(); } else if (action === 'send-audio') { groupAttachmentInput.accept = "audio/*"; groupAttachmentInput.onchange = handleGroupFileSend; groupAttachmentInput.click(); } else if (action === 'change-profile-settings') { showProfileSettingsView(); } }); }); }
        
        function handleGroupFileSend(event) { const file = event.target.files[0]; if (!file || !userNickname) return; let maxSizeMB = 5; let fileTypeCategory = 'file'; if (file.type.startsWith('image/')) { maxSizeMB = 5; fileTypeCategory = 'gambar'; } else if (file.type.startsWith('video/')) { maxSizeMB = 10; fileTypeCategory = 'video'; } else if (file.type.startsWith('audio/')) { maxSizeMB = 10; fileTypeCategory = 'audio'; } if (file.size > maxSizeMB * 1024 * 1024) { alert(`Ukuran ${fileTypeCategory} terlalu besar! Maksimum ${maxSizeMB}MB.`); if (groupAttachmentInput) groupAttachmentInput.value = null; return; } const loadingMessageId = `loading-${Date.now()}`; const loadingText = `<i>‚è≥ Mengirim ${fileTypeCategory}: ${file.name}...</i>`; addMessageToChatUI(loadingText, 'system-message', true, messagesAreaGroupChat, null, null, loadingMessageId); const reader = new FileReader(); reader.onload = (e_reader) => { const loadingMessageElement = document.getElementById(loadingMessageId); if (loadingMessageElement) { loadingMessageElement.remove(); } const filePayload = { type: 'file_message', nickname: userNickname, filename: file.name, filetype: file.type, filecontent: e_reader.target.result }; sendGroupMessage(null, filePayload); }; reader.onerror = (error) => { const loadingMessageElement = document.getElementById(loadingMessageId); if (loadingMessageElement) { loadingMessageElement.remove(); } console.error("Error membaca file:", error); addMessageToChatUI("Gagal memproses file.", 'system-error', true, messagesAreaGroupChat); }; reader.readAsDataURL(file); if (groupAttachmentInput) groupAttachmentInput.value = null; }
        
        if(scrollToBottomButton) { scrollToBottomButton.addEventListener('click', () => { if(messagesAreaGroupChat) messagesAreaGroupChat.scrollTop = messagesAreaGroupChat.scrollHeight; }); }
        if(messagesAreaGroupChat) { messagesAreaGroupChat.addEventListener('scroll', checkScrollPosition); }
        if(sendMediaButton) { sendMediaButton.addEventListener('click', () => { if (pendingMediaFile && pendingMediaDataURL) { const caption = mediaCaptionInput.value.trim(); const filePayload = { type: 'file_message', nickname: userNickname, filename: pendingMediaFile.name, filetype: pendingMediaFile.type, filecontent: pendingMediaDataURL, caption: caption || null }; sendGroupMessage(null, filePayload); hideMediaPreview(); } }); }
        if(cancelMediaButton) { cancelMediaButton.addEventListener('click', hideMediaPreview); }

        window.addEventListener('click', (e) => { if (groupChatAttachmentMenu && groupChatAttachmentMenu.style.display === 'block' && !groupChatMenuButton.contains(e.target) && !groupChatAttachmentMenu.contains(e.target)) { groupChatAttachmentMenu.style.display = 'none'; } });
        if(groupChatMessageInput) { groupChatMessageInput.addEventListener('input', () => { if (!websocket || websocket.readyState !== WebSocket.OPEN) return; clearTimeout(typingTimer); websocket.send(JSON.stringify({ type: 'typing', nickname: userNickname, isTyping: true })); typingTimer = setTimeout(() => { websocket.send(JSON.stringify({ type: 'typing', nickname: userNickname, isTyping: false })); }, TYPING_TIMER_LENGTH); }); }
        
        // Inisialisasi Aplikasi
        showHomeView(); 
    });
    </script>
</body>
</html>
